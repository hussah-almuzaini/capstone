<!-- === index.html UPDATED WITH AUTO-VOICE AND SKIP BUTTON === -->
<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <style>
    .corner-button {
      position: fixed;
      width: 20vw;
      height: 20vh;
      z-index: 999;
      background: transparent;
    }
    #corner-top-left    { top: 0; left: 0; }
    #corner-top-right   { top: 0; right: 0; }
    #corner-bottom-left { bottom: 0; left: 0; }
    #corner-bottom-right{ bottom: 0; right: 0; }
  </style>
</head>
<body>
  <img id="logo" src="/static/logo.png" alt="Ø´Ø¹Ø§Ø± Ø¨ØµÙŠØ±">
  <h1 id="pageTitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
  <button id="startButton">ğŸ¤ Ø£ÙØªØ­ Ø§Ù„Ù…Ø§ÙŠÙƒ </button>
  <audio id="audioPlayer" style="display: none;" controls></audio>
  <audio id="beep" src="/static/beep.wav" style="display:none"></audio>
  <audio id="intro" src="/static/intro.wav" style="display:none"></audio>
  <!-- Corner Hotzones -->
  <div class="corner-button" id="corner-top-left" onclick="window.location.href='/static/upload.html'"></div>
  <div class="corner-button" id="corner-top-right" onclick="window.location.href='/static/stream.html'"></div>
  <div class="corner-button" id="corner-bottom-left" onclick="window.location.href='/static/search.html'"></div>
  <div class="corner-button" id="corner-bottom-right" onclick="fetch('/news', {method: 'POST'}).then(res => res.json()).then(data => speak(data.news || 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±'))"></div>

  <script>
    let alreadySpoken = false;
    let isSpeaking = false;
    const socket = new WebSocket("ws://localhost:8000/ws");
    const player = document.getElementById("audioPlayer");

    function speak(text, callback = null) {
      isSpeaking = true;
      const formData = new FormData();
      formData.append("text", text);

      fetch("/speak", {
        method: "POST",
        body: formData
      })
      .then(response => response.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        player.src = url;
        player.play();
        player.onended = () => {
          isSpeaking = false;
          if (callback) callback();
        };
      })
      .catch(err => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err);
        isSpeaking = false;
        if (callback) callback();
      });
    }

    function handleVoiceCommand(text) {
      const cleaned = text.toLowerCase().replace(/Ø§Ù„/g, "").trim();

      if (cleaned.includes("Ø¨ØµÙŠØ±")) {
        speak("Ø£Ù‡Ù„Ø§Ù‹");
        return;
      }

      if (cleaned.includes("Ø¨Ø­Ø«")) {
        window.location.href = "/static/search.html";
      } else if (cleaned.includes("Ø¨Ø«")) {
        window.location.href = "/static/stream.html";
      } else if (cleaned.includes("Ø±ÙØ¹")) {
        window.location.href = "/static/upload.html";
      } else if (cleaned.includes("Ø±Ø¦ÙŠØ³ÙŠØ©")) {
        window.location.href = "/";
      } else if (cleaned.includes("Ø®Ø¨Ø±")|| cleaned.includes("Ø£Ø®Ø¨Ø§Ø±")|| cleaned.includes("Ø§Ø®Ø¨Ø§Ø±")|| cleaned.includes("Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±")) {
        speak("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...", () => {
          fetch("/news", { method: "POST" })
            .then(res => res.json())
            .then(data => {
              const newsText = data.news || "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±";
              speak(newsText, () => {
                const beep = document.getElementById("beep");
                beep.currentTime = 0;
                beep.play();
              });
            })
            .catch(err => {
              console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±:", err);
              speak("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±.");
            });
        });
        return;
      }
      socket.send(text);
    }

    function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ar-SA';
      recognition.start();

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript.trim();
        handleVoiceCommand(text);
      };

      recognition.onerror = e => console.warn("âŒ", e.error);
      recognition.onend = () => recognition.start();
    }

    socket.onmessage = function(event) {
      const msg = event.data;
      if (msg.startsWith("redirect:")) {
        const targetURL = msg.split("redirect:")[1];
        window.location.href = targetURL;
        return;
      }
      if (msg.startsWith("goto:")) {
        const rawPage = msg.split(":")[1];
        handleVoiceCommand(rawPage);
      } else {
        document.getElementById("pageTitle").innerText = msg;
      }
    };

    document.getElementById("startButton").onclick = () => {
      if (isSpeaking) {
        player.pause();
        player.currentTime = 0;
        isSpeaking = false;
      }
      const intro = document.getElementById("intro");
      intro.pause();
      intro.currentTime = 0;
      
      startListening();
      document.getElementById("startButton").style.display = "none";
    };

    // window.onload = () => {
    //   alreadySpoken = true;
    //   speak("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø±ÙØ¹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹ Ùˆ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù‚ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø±ÙØ¹. Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø« Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø§ ÙŠØ¬Ø±ÙŠ Ø­ÙˆØ§Ù„ÙŠÙƒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù‚ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø«. Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø¨Ø­Ø« Ù„ Ø§Ø´ÙŠØ§Ø¡ Ù…Ø¹ÙŠÙ†Ø© Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù‚ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«. Ù„Ø³Ù…Ø§Ø¹ Ù…ÙˆØ¬Ø² Ø§Ø®Ø± Ø§Ù„Ø§Ø®Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù‚ÙˆÙ„ Ø®Ø¨Ø± Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¶ØºØ· Ø²Ø§ÙˆÙŠØ© ÙÙˆÙ‚ ÙŠØ³Ø§Ø± Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø±ÙØ¹ØŒ Ø²Ø§ÙˆÙŠØ© ÙÙˆÙ‚ ÙŠÙ…ÙŠÙ† Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø«ØŒ Ø²Ø§ÙˆÙŠØ© ØªØ­Øª ÙŠØ³Ø§Ø± Ù„Ø¯Ø®ÙˆÙ„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«ØŒ ØªØ­Øª ÙŠÙ…ÙŠÙ† Ù„Ø³Ù…Ø§Ø¹ Ø§Ø®Ø± Ø§Ù„Ø§Ø®Ø¨Ø§Ø±", () => {
    //     startListening();
    //     document.getElementById("startButton").style.display = "none";
    //   });
    // };
//     window.onload = () => {
//     alreadySpoken = true;
//     const intro = document.getElementById("intro");
//     intro.currentTime = 0;
//     intro.play();
//     intro.onended = () => {
//       startListening();
//       document.getElementById("startButton").style.display = "none";
//   };
// };
    window.onload = () => {
      alreadySpoken = true;
      const intro = document.getElementById("intro");
      const welcomeBackText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";

      if (!localStorage.getItem("introPlayed")) {
        // First visit: play intro audio
        intro.currentTime = 0;
        intro.play();
        intro.onended = () => {
          localStorage.setItem("introPlayed", "yes");
          startListening();
          document.getElementById("startButton").style.display = "none";
        };
      } else {
        // Returning user: play welcome back message
        speak(welcomeBackText, () => {
          startListening();
          document.getElementById("startButton").style.display = "none";
        });
      }
    };
  </script>

<div class="bg"></div>
<div class="bg bg2"></div>
<div class="bg bg3"></div>
<div class="bg bg4"></div>
<div class="gif-background"></div>
</body>
</html>
