<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
  <img id="logo" src="/static/logo.png" alt="Ø´Ø¹Ø§Ø± Ø¨ØµÙŠØ±">
  <h1 id="pageTitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
  <button id="startButton">ğŸ¤ Ø§Ø¶ØºØ·ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>

  <!-- Ù…Ø´ØºÙ„ ØµÙˆØª (Ù…Ø®ÙÙŠ) -->
  <audio id="audioPlayer" style="display: none;" controls></audio>

  <script>
    let selectedVoice = null;
    let continuousRecognition = null;
    let awaitingCommand = false;
    let alreadySpoken = false;

    const socket = new WebSocket("ws://localhost:8000/ws");

    function speak(text, callback = null) {
      const formData = new FormData();
      formData.append("text", text);

      fetch("/speak", {
        method: "POST",
        body: formData
      })
      .then(response => response.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const player = document.getElementById("audioPlayer");
        player.src = url;
        player.play();
        player.onended = () => {
          if (callback) callback();
        };
      })
      .catch(err => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err);
        if (callback) callback();
      });
    }

    function startListening() {
      continuousRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      continuousRecognition.lang = 'ar-SA';
      continuousRecognition.start();

      continuousRecognition.onresult = function(event) {
        const text = event.results[0][0].transcript.trim().toLowerCase();

        if (text.includes("Ø¨ØµÙŠØ±") && !awaitingCommand) {
          awaitingCommand = true;
          socket.send(text); // ÙÙ‚Ø· Ø¥Ø±Ø³Ø§Ù„
          return;
        }

        if (awaitingCommand) {
          socket.send(text);
          return;
        }
      };

      continuousRecognition.onerror = e => console.warn("âŒ", e.error);
      continuousRecognition.onend = () => continuousRecognition.start();
    }

    socket.onmessage = function(event) {
      const msg = event.data;

      if (msg.startsWith("redirect:")) {
        const targetURL = msg.split("redirect:")[1];
        window.location.href = targetURL;
        return;
      }

      if (msg.startsWith("goto:")) {
        const rawPage = msg.split(":")[1];
        const cleanedPage = rawPage.replace(/\u0627\u0644/g, "").trim();

        if (cleanedPage.includes("Ø¨Ø­Ø«")) {
          window.location.href = "/static/search.html";
        } else if (cleanedPage.includes("Ø¨Ø«")) {
          window.location.href = "/static/stream.html";
        } else if (cleanedPage.includes("Ø±ÙØ¹")) {
          window.location.href = "/static/upload.html";
        }
      } else if (msg === "intro") {
        speak("Ø£Ù‡Ù„Ø§Ù‹ØŸ");
        awaitingCommand = true;
      } else {
        document.getElementById("pageTitle").innerText = msg;
      }
    };

    document.getElementById("startButton").onclick = () => {
      const trigger = () => {
        if (alreadySpoken) return;
        alreadySpoken = true;
        speak("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", () => {
          startListening();
        });
        document.getElementById("startButton").style.display = "none";
      };

      if (speechSynthesis.getVoices().length === 0) {
        speechSynthesis.onvoiceschanged = trigger;
      } else {
        trigger();
      }
    };
  </script>
</body>
</html>
