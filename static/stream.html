<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>البث المباشر مع الترجمة</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>📷 البث المباشر مع الترجمة</h1>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <div id="captions">
    <h3>📝 الوصف بالإنجليزية:</h3>
    <p id="captionEN">...</p>
    <h3>🌍 الترجمة:</h3>
    <p id="captionAR">...</p>
  </div>

  <audio id="audioPlayer" style="display: none;" controls></audio>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const ws = new WebSocket("ws://localhost:8000/ws");

    const captionEN = document.getElementById("captionEN");
    const captionAR = document.getElementById("captionAR");
    const audioPlayer = document.getElementById("audioPlayer");

    function speak(text) {
      const formData = new FormData();
      formData.append("text", text);

      fetch("/speak", {
        method: "POST",
        body: formData
      })
      .then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        audioPlayer.src = url;
        audioPlayer.play();
      })
      .catch(err => console.error("❌ فشل في تشغيل الصوت:", err));
    }

    // 🧠 Receive caption messages
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "caption") {
        captionEN.innerText = msg.text || "لا يوجد وصف";
        captionAR.innerText = msg.arabic || "❌ الترجمة غير متوفرة";
        if (msg.arabic && msg.arabic !== "❌ الترجمة غير متوفرة") {
          speak(msg.arabic);
        }
      }
    };

    // 📸 Start camera
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      // 🔁 Send frame every second
      setInterval(() => {
  if (ws.readyState === WebSocket.OPEN) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/jpeg");
    ws.send(JSON.stringify({
      type: "frame",
      data: dataUrl
    }));
  } else {
    console.warn("⚠️ WebSocket مغلق، لم يتم إرسال الإطار.");
  }
}, 1000);
    }).catch(err => {
      alert("🚫 فشل في الوصول إلى الكاميرا: " + err.message);
    });
  </script>
</body>
</html>