<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุงูุจุซ ุงููุจุงุดุฑ ูุน ุงูุชุฑุฌูุฉ</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>๐ท ุงูุจุซ ุงููุจุงุดุฑ ูุน ุงูุชุฑุฌูุฉ</h1>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <div id="captions">
    <h3>๐ ุงููุตู ุจุงูุฅูุฌููุฒูุฉ:</h3>
    <p id="captionEN">...</p>
    <h3>๐ ุงูุชุฑุฌูุฉ:</h3>
    <p id="captionAR">...</p>
  </div>

  <audio id="audioPlayer" style="display: none;" controls></audio>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const ws = new WebSocket("ws://localhost:8000/ws");

    const captionEN = document.getElementById("captionEN");
    const captionAR = document.getElementById("captionAR");
    const audioPlayer = document.getElementById("audioPlayer");

    function speak(text) {
      const formData = new FormData();
      formData.append("text", text);

      fetch("/speak", {
        method: "POST",
        body: formData
      })
      .then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        audioPlayer.src = url;
        audioPlayer.play();
      })
      .catch(err => console.error("โ ูุดู ูู ุชุดุบูู ุงูุตูุช:", err));
    }

    // ๐ง Receive caption messages
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "caption") {
        captionEN.innerText = msg.text || "ูุง ููุฌุฏ ูุตู";
        captionAR.innerText = msg.arabic || "โ ุงูุชุฑุฌูุฉ ุบูุฑ ูุชููุฑุฉ";
        if (msg.arabic && msg.arabic !== "โ ุงูุชุฑุฌูุฉ ุบูุฑ ูุชููุฑุฉ") {
          speak(msg.arabic);
        }
      }
    };

    // ๐ธ Start camera
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      // ๐ Send frame every second
      setInterval(() => {
  if (ws.readyState === WebSocket.OPEN) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/jpeg");
    ws.send(JSON.stringify({
      type: "frame",
      data: dataUrl
    }));
  } else {
    console.warn("โ๏ธ WebSocket ูุบููุ ูู ูุชู ุฅุฑุณุงู ุงูุฅุทุงุฑ.");
  }
}, 1000);
    }).catch(err => {
      alert("๐ซ ูุดู ูู ุงููุตูู ุฅูู ุงููุงููุฑุง: " + err.message);
    });
  </script>
</body>
</html>