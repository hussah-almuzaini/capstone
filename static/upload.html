<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุตูุญุฉ ุฑูุน ุงูููู</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<div class="corner-button" id="corner-top-left" onclick="window.location.href='/'"></div>
<style>
  .corner-button {
    position: fixed;
    width: 20vw;
    height: 20vh;
    z-index: 999;
    background: transparent;
  }
  #corner-top-left {
    top: 0;
    left: 0;
  }
</style>
<body>
  <img id="logo" src="/static/logo.png" alt="ุดุนุงุฑ ุจุตูุฑ">
  <h1>ูุฑุญุจุงู ุจู ูู ุตูุญุฉ ุฑูุน ุงูููู</h1>
  <p id="heardText">๐ง ุจุงูุชุธุงุฑ ุงูุตูุช...</p>

  <div id="result" style="border-top: none;"></div>

  <!-- ูุดุบู ุตูุช ูุฎูู -->
  <audio id="audioPlayer" style="display: none;" controls></audio>

  <script>
    const resultBox = document.getElementById("result");
    const audioPlayer = document.getElementById("audioPlayer");

    let isSpeaking = false;

    // ๐ค ุชูุนูู ุงูุชุนุฑู ุนูู ุงูููุงู
    const r = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    r.lang = 'ar-SA';

    // ๐ ูุธููุฉ ุงููุทู
    const speak = (text) => {
      const formData = new FormData();
      formData.append("text", text);
      fetch("/speak", { method: "POST", body: formData })
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          audioPlayer.src = url;

          isSpeaking = true;
          audioPlayer.play();

          audioPlayer.onended = () => {
            console.log("โ ุงูุชูู ุงูุตูุชุ ูุนูุฏ ุงูุงุณุชูุงุน");
            isSpeaking = false;
            document.getElementById("heardText").innerText = "๐ง ุจุงูุชุธุงุฑ ุงูุตูุช...";
            listen(); // ุฅุนุงุฏุฉ ุงูุงุณุชูุงุน ุจุนุฏ ุงูุชูุงุก ุงููุทู
          };
        });
    };

    // ๐ง ูุธููุฉ ุฑูุน ูุชุญููู ุงูููู
    const uploadAndAnalyze = async () => {
      document.getElementById("heardText").innerText = "โณ ุฌุงุฑู ุงูุชุญููู...";
      const t0 = performance.now();

      try {
        console.log("๐ ุจุฏุก ุงูุชุญููู");

        const analyzeRes = await fetch("/analyze_from_static", {
          method: "POST"
        });

        const analyzeData = await analyzeRes.json();
        console.log("๐ธ ุงูุชุญููู ุชู:", Math.round(performance.now() - t0), "ms");

        if (analyzeData.error) {
          resultBox.innerHTML = "โ ุฎุทุฃ: " + analyzeData.error;
          return;
        }

        const captions = analyzeData.captions;
        const fullText = captions.join("\n");

        const t1 = performance.now();
        console.log("๐ ุจุฏุก ุงูุชุฑุฌูุฉ");

        const translationRes = await fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: fullText })
        });

        const translationData = await translationRes.json();
        console.log("๐ ุงูุชุฑุฌูุฉ ุชูุช:", Math.round(performance.now() - t1), "ms");

        const translated = translationData.translated || "โ ูู ูุชู ุงูุชุฑุฌูุฉ";

        const t2 = performance.now();
        console.log("๐ ุจุฏุก ุงููุทู");
        speak(translated);
        console.log("โ ูู ุงูุนูููุฉ ุชูุช ุฎูุงู:", Math.round(performance.now() - t0), "ms");

      } catch (err) {
        resultBox.innerHTML = "โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฎุงุฏู.";
        console.error("โ๏ธ Server error:", err);
      }
    };

    // ๐ง ูุธููุฉ ุงูุงุณุชูุงุน ููุฃูุงูุฑ
    const listen = () => {
      if (isSpeaking) {
        console.log("๐ ุงูุตูุช ูุดุชุบูุ ููุชุธุฑ...");
        return;
      }

      try {
        r.onstart = () => console.log("๐ค ุจุฏุฃ ุงูุงุณุชูุงุน...");
        r.onend = () => setTimeout(() => {
          if (!isSpeaking) listen();
        }, 800);

        r.onerror = () => setTimeout(() => {
          if (!isSpeaking) listen();
        }, 800);

        r.onresult = e => {
          const t = e.results[0][0].transcript.trim();
          const cleaned = t.toLowerCase().replace(/ุงู/g, "").trim();
          console.log("๐ง ุณูุนุช:", t, "| ุจุนุฏ ุงูุชูุธูู:", cleaned);

          if (cleaned.includes("ุจุญุซ")) {
            window.location.href = "/static/search.html";
          } else if (cleaned.includes("ุจุซ")) {
            window.location.href = "/static/stream.html";
          } else if (cleaned.includes("ุฑูุน") || cleaned.includes("ุงูุชุญ")) {
            uploadAndAnalyze();
          } else if (cleaned.includes("ุฑุฆูุณูู")) {
            window.location.href = "/";
          }
          else if (cleaned.includes("ุฎุจุฑ")) {
  fetch("/news", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      const newsText = data.news || "โ ูู ูุชู ุงูุญุตูู ุนูู ุงูุฃุฎุจุงุฑ";
      speak(newsText);
    })
    .catch(err => {
      console.error("โ ุฎุทุฃ ูู ุฌูุจ ุงูุฃุฎุจุงุฑ:", err);
      speak("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงูุฃุฎุจุงุฑ.");
    });
}


        };

        r.start();
      } catch (err) {
        console.log("โ ุฎุทุฃ ุฃุซูุงุก ุจุฏุก ุงูุงุณุชูุงุน:", err);
      }
    };

    // โฑ๏ธ ุชุดุบูู ุงูุงุณุชูุงุน ุนูุฏ ูุชุญ ุงูุตูุญุฉ
    listen();

    window.onload = () => {
  speak("ุฅุฐุง ููุช ุชุฑูุฏ ุฑููุน ุงูููุทุนุ ุงูุฑุฌุงุก ููู: ุงูุชุญ ุฃู ุญูู ุงูููู");
  listen();
};
    

    // ๐ ุชุญูู ุฏูุฑู: ุฅุนุงุฏุฉ ุชูุนูู ุงูุงุณุชูุงุน ุฅุฐุง ุชููู ูุฌุฃุฉ
    setInterval(() => {
      if (!isSpeaking) {
        console.log("๐ ุชุญูู ุฏูุฑู: ุฅุนุงุฏุฉ ุชูุนูู ุงูุงุณุชูุงุน ุฅุฐุง ุชููู");
        listen();
      }
    }, 10000);
  </script>
 <div class="bg"></div>
 <div class="bg bg2"></div>
 <div class="bg bg3"></div>
 <div class="bg bg4"></div>

</body>
</html>




