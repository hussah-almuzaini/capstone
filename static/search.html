<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ุตูุญุฉ ุงูุจุญุซ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

</head>
<body>
  <img id="logo" src="/static/logo.png" alt="ุดุนุงุฑ ุจุตูุฑ">
  <h1>๐ ูุฑุญุจูุง ุจู ูู ุตูุญุฉ ุงูุจุญุซ</h1>
  <p id="heardText">๐ง ุจุงูุชุธุงุฑ ุงูุตูุช...</p>
  <p id="searchResult"></p>

  <audio id="audioPlayer" style="display: none;" controls></audio>

  <script>
    let isListening = false;

    function speak(text, callback = null) {
      const formData = new FormData();
      formData.append("text", text);

      fetch("/speak", {
        method: "POST",
        body: formData
      })
      .then(response => response.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const player = document.getElementById("audioPlayer");
        player.src = url;
        player.play();
        player.onended = () => {
          if (callback) callback();
        };
      })
      .catch(err => {
        console.error("โ ุฎุทุฃ ูู ุงูุตูุช:", err);
        if (callback) callback();
      });
    }

    const show = (text) => {
      document.getElementById("heardText").innerText = `๐ฌ ${text}`;
    };

    const listen = () => {
      const r = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      r.lang = 'ar-SA';

      r.onstart = () => isListening = true;
      r.onend = () => { isListening = false; setTimeout(listen, 800); };
      r.onerror = () => { isListening = false; setTimeout(listen, 800); };

      r.onresult = e => {
        const t = e.results[0][0].transcript.trim();
        const cleaned = t.toLowerCase().replace(/ุงู/g, "").trim();
        show("๐ง ุณูุน: " + t);

        const searchTriggers = ["ุงุจุบู ุงุจุญุซ ุนู", "ุฃุจุญุซ ุนู", "ุงุจุญุซ ุนู"];
        for (let phrase of searchTriggers) {
          if (cleaned.includes("ุนู")) {
            let object = cleaned.split("ุนู").pop().trim();
            document.getElementById("searchResult").innerText = `๐ ุงููุงุฆู ุงููุฑุงุฏ ุงูุจุญุซ ุนูู: ${object}`;
            speak("ุฌุงุฑู ุงูุจุญุซ ุนู " + object);
            return;
          }
        }

        if (cleaned.includes("ุจุญุซ")) {
          window.location.href = "/static/search.html";
        } else if (cleaned.includes("ุจุซ")) {
          window.location.href = "/static/stream.html";
        } else if (cleaned.includes("ุฑูุน")) {
          window.location.href = "/static/upload.html";
        } else if (cleaned.includes("ุฑุฆูุณูู")) {
          window.location.href = "/";
        }
      };

      r.start();
    };

    // โ ุชู ุชุนุฏูู ูุฐุง ุงูุฌุฒุก:
    window.onload = () => {
      speak("ุตูุญุฉ ุงูุจุญุซ", () => {
        speak("ูุง ุงูุฐู ุชุฑูุฏ ุงูุนุซูุฑ ุนูููุ", () => {
          listen();
        });
      });
    };
  </script>
</body>
</html>
